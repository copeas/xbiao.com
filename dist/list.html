<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
     <!-- 瀑布流 -->
     <div class="watch_container clearfix">
            <ul class="clearfix">
                <!-- <li>
                    <img src="https://img3.doubanio.com/view/photo/s_ratio_poster/public/p480747492.webp" alt="">
                    <h3>这是一个标题</h3>
                    <button>加入购物车</button>
                </li> -->
                
                   
            </ul>
        </div>
        
         <script
         src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
         <script >
            // 瀑布流
            function ShopCar(){
            }
            $.extend(ShopCar.prototype,{
                init:function(){
                    this.page=1;
                    this.main = $(".watch_container ul");
                    this.loading = false;
                    this.loadJson()
                    .then(function(res){
                        //console.log(res);
                        this.json = res.subjects;
                        this.renderPage()
                    })
                    this.bindEvent();
                },
                loadJson:function(){
                    var opt = {
                        url:"http://localhost:82/proxy/api.douban.com/v2/movie/top250",
                        data:{start:this.page,count:40},
                        type:"GET",
                        context : this
                    }
                    return $.ajax(opt);
                },
                renderPage:function(){
                    console.log(this.json)
                    var html = "";
                    for(var i = 0 ; i < this.json.length ; i ++){
                        html += `<li>
                                    <img src="${this.json[i].images.small}" alt="">
                                    <h3>${this.json[i].title}</h3>
                                    <button>买不买</button>
                                </li>`
                        //console.log(this.json[i].title)
                    }
                    this.main.html(this.main.html() + html);
                    this.sortPage();
                    this.loading = true;
                },
                sortPage(){
                    // var aBox = this.main.children();
                    // // console.log(aBox);
                    // var heightArray = [];
                    // for(var i = 0 ; i < aBox.length ; i ++ ){
                    //     // 第一排设置基准;
                    //     if( i < 10){
                    //         console.log(aBox.eq(i));
                    //         heightArray.push(aBox.eq(i).height());
                    //      }else{
                    //         // 找到最小值 （第一排中最矮的一个）
                    //         // Math.min.apply => 可取的数组中的最小值;
                    //         var min = Math.min.apply(false,heightArray);
                    //         // 最小值和最小值的下标;
                    //         var minIndex = heightArray.indexOf(min);
                            
                    //          // 给最小值加上拼接之后的高度;
                    //          heightArray[minIndex] += aBox.eq(i).height();
                    //     }
                    // }
                    // this.loading = false;

                    if(this.loading == false){
                        return 0;
                    }
                    var scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
                    // 显示的高度有多高;
                    var showHeight = document.documentElement.clientHeight + scrollTop;
                    // 最后一个元素;
                    var aBox = this.main.children();
                // console.log(aBox);
                    var lastLi = aBox[aBox.length - 1];
                    if(lastLi.offsetTop <= showHeight + 200){
                        // 加载数据                    
                        this.loadJson()                    
                        this.renderPage();
                        
                        console.log(this.page) ;           
                    }
                    this.loading = false;
                },
                bindEvent(){
                    $(window).on("scroll",this.sortPage.bind(this));
                },
                // ifLoad(){
                //     // console.log(1);
                //     // scrollTop ;
                //     // 最后一张图片;
                //     // 当前屏幕的高度;
                //     var scrollTop = $("html,body").scrollTop();
                //     var clientHeight = $("html")[0].clientHeight;
                //     var lastBox = this.main.children(":last");
                //     // console.log(scrollTop,clientHeight,lastBox.offset());
                //     if(scrollTop + clientHeight > lastBox.offset().top){
                //         // 加载数据;
                //         if(this.loading){
                //             return 0;
                //         }
                //         this.loading = true;
                //          console.log("加载");
                //         this.page ++;
                //         this.loadJson()
                //         .then(function(){
                //             // deferred 的 done 回调 this指向的都是 jquery 对象本身
                //             //console.log(res,this);
                //             this.renderPage();
                //         })
                //     }
                // }
            })
            var car = new ShopCar();
            car.init();
        </script>   
</body>
</html>